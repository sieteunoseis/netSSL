# Docker Compose for netSSL
# Option 1 (pull): docker compose up -d
# Option 2 (build from source): docker compose up --build -d
# Environment variables can be customized in .env (see .env.example)

name: netssl

services:
  app:
    build: .
    image: ghcr.io/sieteunoseis/netssl:latest
    container_name: netssl-dashboard
    ports:
      - "3000:80"  # nginx serves frontend and proxies API
    environment:
      # Frontend Branding Configuration
      - VITE_BRANDING_URL=${VITE_BRANDING_URL:-https://automate.builders}
      - VITE_BRANDING_NAME=${VITE_BRANDING_NAME:-Automate Builders}
      - VITE_BACKGROUND_LOGO_TEXT=${VITE_BACKGROUND_LOGO_TEXT:-NETSSL}
      # Frontend Debug Configuration
      - VITE_DEBUG=${VITE_DEBUG:-false}
      - VITE_DEBUG_WEBSOCKET=${VITE_DEBUG_WEBSOCKET:-false}
      # Backend Configuration
      - PORT=${PORT:-3000}
      - NODE_ENV=${NODE_ENV:-production}
      # Certificate Auto-Renewal Configuration
      - CERT_RENEWAL_DAYS=${CERT_RENEWAL_DAYS:-7}
      - CERT_WARNING_DAYS=${CERT_WARNING_DAYS:-30}
      - CERT_CHECK_SCHEDULE=${CERT_CHECK_SCHEDULE:-0 0 * * *}
      # Let's Encrypt Configuration
      - LETSENCRYPT_STAGING=${LETSENCRYPT_STAGING:-true}
      # Certificate accounts directory
      - ACCOUNTS_DIR=${ACCOUNTS_DIR:-./accounts}
      # Logging Configuration
      - LOG_TO_FILE=${LOG_TO_FILE:-false}
      - LOG_DIR=${LOG_DIR:-./logs}
      - LOG_MAX_SIZE=${LOG_MAX_SIZE:-20m}
      - LOG_MAX_FILES=${LOG_MAX_FILES:-14d}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - app_db:/app/backend/db  # Persist database
      - app_accounts:/app/backend/accounts  # Persist certificates and accounts
      - app_logs:/app/backend/logs  # Persist log files
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/data"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

volumes:
  app_db:
    driver: local
  app_accounts:
    driver: local
  app_logs:
    driver: local
